<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>RNAscrutiny.RNAscrutiny &mdash; RNAscrutiny 0.0 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" >
    <link rel="search" title="Search" href="../../search.html" >
    <link rel="top" title="RNAscrutiny 0.0 documentation" href="../../index.html" >
    <link rel="up" title="Module code" href="../index.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
        <li class="active"><a href="https://lbm.niddk.nih.gov">LBM</a></li>
        <li class="active"><a href="https://pypi.python.org/pypi/RNAscrutiny">RNAscrutiny</a></li>
	
        <li class="active"><a href="../../index.html">RNAscrutiny 0.0 documentation</a></li>
	
          <li class="active"><a href="../index.html" accesskey="U">Module code</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">

        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  <h1>Source code for RNAscrutiny.RNAscrutiny</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="k">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">tree</span> <span class="k">import</span> <span class="n">Tree</span>

<span class="n">__outputDir</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">__verbose</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">outputDir</span><span class="o">=</span><span class="s1">&#39;./RNAscrutiny-output&#39;</span><span class="p">,</span>
         <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">1e8</span><span class="p">),</span>
         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">__outputDir</span>
    <span class="k">global</span> <span class="n">__verbose</span>

    <span class="c1"># set output directory</span>
    <span class="n">__outputDir</span> <span class="o">=</span> <span class="n">outputDir</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outputDir</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unable to create output directory.&#39;</span><span class="p">)</span>

    <span class="c1"># seed random number generators</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># set verbosity</span>
    <span class="n">__verbose</span> <span class="o">=</span> <span class="n">verbose</span></div>


<div class="viewcode-block" id="generateGeneCorrelationMatrix"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.generateGeneCorrelationMatrix">[docs]</a><span class="k">def</span> <span class="nf">generateGeneCorrelationMatrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>
                                  <span class="n">networkStructure</span><span class="o">=</span><span class="s1">&#39;TRRUST&#39;</span><span class="p">,</span>
                                  <span class="n">maxAlphaBeta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                  <span class="n">normalizeWRows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">powerLawExponent</span><span class="o">=</span><span class="mf">2.05</span><span class="p">,</span>
                                  <span class="n">networkSparsity</span><span class="o">=</span><span class="mf">0.999</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate correlation matrix of gene regulatory network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    networkStructure : string</span>
<span class="sd">        type of network structure, must be one of &#39;SimulatedPowerLaw&#39;, &#39;TRRUST&#39;, &#39;Random&#39;</span>
<span class="sd">    maxAlphaBeta : float</span>
<span class="sd">        maximum value of the beta distribution alpha and beta parameters</span>
<span class="sd">    normalizeWRows : logical</span>
<span class="sd">        choose whether to divide each row of :math:`W` by the number of connections</span>
<span class="sd">    powerLawExponent : float</span>
<span class="sd">        exponent for simulated power law network, higher values imply more connections, recommended value between 2 and 3</span>
<span class="sd">    networkSparsity : float</span>
<span class="sd">        fraction of genes unrelated in network.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        Gene correlation matrix, entry i,j is the correlation between genes i and j.</span>
<span class="sd">    tf : ndarray(*,)</span>
<span class="sd">        List of transcription factors. A transcription factor is defined as a gene with a nonzero outdegree in the gene network.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># adjacency matrix of gene network</span>
    <span class="n">networkMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># Generate the network structure</span>
    <span class="k">if</span> <span class="n">networkStructure</span> <span class="o">==</span> <span class="s2">&quot;SimulatedPowerLaw&quot;</span><span class="p">:</span>

        <span class="c1">#Generate number of in and out connections per gene</span>
        <span class="n">inConnections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">outConnections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inConnections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">())</span><span class="o">**</span>
                                   <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">powerLawExponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">outConnections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">())</span><span class="o">**</span>
                                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">powerLawExponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Make sure number of in and out connections is not greater than the number of genes</span>
        <span class="n">inConnections</span><span class="p">[</span><span class="n">inConnections</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">outConnections</span><span class="p">[</span><span class="n">outConnections</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="c1"># Set up a multiset of the number of outconnections each gene has</span>
        <span class="c1"># then, for each gene, sample the inconnections from</span>
        <span class="c1"># the multiset of outconnections and remove duplicates</span>
        <span class="n">outNodesSamplePool</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">outNodesSamplePool</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">outConnections</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">connectionIndexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">outNodesSamplePool</span><span class="p">,</span>
                                              <span class="n">inConnections</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">connectionIndexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">connectionIndexes</span><span class="p">))</span>
            <span class="n">networkMatrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">connectionIndexes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">networkStructure</span> <span class="o">==</span> <span class="s2">&quot;TRRUST&quot;</span><span class="p">:</span>
        <span class="c1"># This can be generated by using AnalyzeTRRUST.py and the original file</span>
        <span class="n">networkMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;TRRUST_Network.npy&#39;</span><span class="p">))</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">networkMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">networkStructure</span> <span class="o">==</span> <span class="s2">&quot;Random&quot;</span><span class="p">:</span>
        <span class="c1">#Randomly generate network using sparsity and binomial distribution for the number of in connections per gene</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">numInConnections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">networkSparsity</span><span class="p">))</span>
            <span class="n">connectionIndexes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">numInConnections</span><span class="p">)</span>
            <span class="n">networkMatrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">connectionIndexes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Invalid network structure. Parameter &quot;networkStructure&quot; must be one of &quot;SimulatedPowerLaw&quot;, &quot;TRRUST&quot;, or &quot;Random&quot;.&#39;</span>
        <span class="p">)</span>

    <span class="n">valueMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="c1"># Generate values for matrix from a Beta distribution using randomly generated</span>
    <span class="c1"># alpha and beta in the range [0, 1, 2, ... , maxAlphaBeta],</span>
    <span class="c1"># then transform the actual values from the (0, 1) range to the (-1, 1) range</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxAlphaBeta</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxAlphaBeta</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">valueMatrix</span><span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span>
            <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># Element-wise multiply network structure matrix and value matrix</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="n">networkMatrix</span> <span class="o">*</span> <span class="n">valueMatrix</span>

    <span class="c1"># If set to true, will divide each value of each row (in connections) by the number of connections</span>
    <span class="k">if</span> <span class="n">normalizeWRows</span><span class="p">:</span>
        <span class="n">rowCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rowCount</span><span class="p">[</span><span class="n">rowCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gc</span> <span class="o">/=</span> <span class="n">rowCount</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># Transcription Factors are defined as genes with a nonzero outdegree</span>
    <span class="n">outDegrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">networkMatrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">outDegrees</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">__outputDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">inDegrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">networkMatrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outDegrees</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">networkMatrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#inDegreesXVals, inDegreesFreq = np.unique(inDegrees, return_counts=True)</span>
        <span class="c1">#outDegreesXVals, outDegreesFreq = np.unique(outDegrees, return_counts=True)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">inDegrees</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Indegree&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="n">networkStructure</span> <span class="o">+</span>
                         <span class="s2">&quot;_Network_Indegree.tiff&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">outDegrees</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Outdegree&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="n">networkStructure</span> <span class="o">+</span>
                         <span class="s2">&quot;_Network_Outdegree.tiff&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">__verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of Connections: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">networkMatrix</span><span class="p">))</span>
        <span class="n">sparsityProportion</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">networkMatrix</span><span class="p">))</span> <span class="o">/</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Network Density: &quot;</span><span class="p">,</span> <span class="n">sparsityProportion</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gc</span><span class="p">,</span> <span class="n">tf</span></div>


<div class="viewcode-block" id="formCellTypeTree"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.formCellTypeTree">[docs]</a><span class="k">def</span> <span class="nf">formCellTypeTree</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">cellTypeParents</span><span class="p">,</span> <span class="n">cellTypeNumCells</span><span class="p">,</span>
                     <span class="n">cellTypeConstProps</span><span class="p">,</span> <span class="n">transcriptionFactors</span><span class="p">,</span> <span class="n">cellTypeMeans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        number of cells</span>
<span class="sd">    cellTypeParents :</span>
<span class="sd">        the value of index `i` is the parent of cell type `i`</span>
<span class="sd">    cellTypeNumCells :</span>
<span class="sd">        the value of index `i` is the number of cells of type `i` to end up with</span>
<span class="sd">    cellTypeConstProps :</span>
<span class="sd">        proportion of transcription factors to set constant indexed by cell type</span>
<span class="sd">    transcriptionFactors :</span>
<span class="sd">        list of genes with positive outdegree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">	cellTypeTree :</span>
<span class="sd">        a tree representation of cell development</span>
<span class="sd">    projMatrix :</span>
<span class="sd">        collection of 0/1 projection vectors, one for each cell type</span>
<span class="sd">    constMatrix :</span>
<span class="sd">        collection of constant vectors, one for each cell type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cellTypeTree</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>

    <span class="n">parentCellType</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">projInit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">constInit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">cellTypeMember</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cellTypeChildMember</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
    <span class="n">cellTypeMean</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">numCellTypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellTypeParents</span><span class="p">)</span>

    <span class="n">projMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numCellTypes</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="n">constMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">numCellTypes</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="n">headNode</span> <span class="o">=</span> <span class="n">cellTypeTree</span><span class="o">.</span><span class="n">add_head</span><span class="p">(</span><span class="n">parentCellType</span><span class="p">,</span> <span class="n">cellTypeMember</span><span class="p">,</span> <span class="n">constInit</span><span class="p">,</span>
                                     <span class="n">projInit</span><span class="p">,</span> <span class="n">cellTypeMean</span><span class="p">)</span>
    <span class="n">headNode</span><span class="o">.</span><span class="n">setChildCellTypeMembers</span><span class="p">(</span><span class="n">cellTypeChildMember</span><span class="p">)</span>

    <span class="n">numCellTypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellTypeParents</span><span class="p">)</span>
    <span class="n">cellTypeMembers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numCellTypes</span><span class="p">)]</span>

    <span class="n">cellNumPool</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cellType</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numCellTypes</span><span class="p">):</span>
        <span class="n">numCells</span> <span class="o">=</span> <span class="n">cellTypeNumCells</span><span class="p">[</span><span class="n">cellType</span><span class="p">]</span>
        <span class="n">cellTypeIndices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cellNumPool</span><span class="p">,</span> <span class="n">numCells</span><span class="p">)</span>
        <span class="n">cellTypeMembers</span><span class="p">[</span><span class="n">cellType</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellTypeIndices</span>
        <span class="n">cellNumPool</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cellNumPool</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">cellTypeIndices</span><span class="p">))</span>

    <span class="n">addTreeChildren</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cellTypeTree</span><span class="p">,</span> <span class="n">cellTypeParents</span><span class="p">,</span> <span class="n">cellTypeMembers</span><span class="p">,</span>
                    <span class="n">cellTypeConstProps</span><span class="p">,</span> <span class="n">projInit</span><span class="p">,</span> <span class="n">constInit</span><span class="p">,</span> <span class="n">projMatrix</span><span class="p">,</span>
                    <span class="n">constMatrix</span><span class="p">,</span> <span class="n">cellTypeMeans</span><span class="p">,</span> <span class="n">parentCellType</span><span class="p">,</span>
                    <span class="n">transcriptionFactors</span><span class="p">)</span>

    <span class="c1">#maxCellType = int(max(cellTypeParents)) #Highest cell type number corresponds to the highest cell type</span>
    <span class="c1"># for node in cellTypeTree.traverse(-1):</span>
    <span class="c1">#     for field in node:</span>
    <span class="c1">#         print(field)</span>

    <span class="k">return</span> <span class="n">cellTypeTree</span><span class="p">,</span> <span class="n">projMatrix</span><span class="p">,</span> <span class="n">constMatrix</span></div>


<div class="viewcode-block" id="addTreeChildren"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.addTreeChildren">[docs]</a><span class="k">def</span> <span class="nf">addTreeChildren</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cellTypeTree</span><span class="p">,</span> <span class="n">cellTypeParents</span><span class="p">,</span> <span class="n">cellTypeMembers</span><span class="p">,</span>
                    <span class="n">cellTypeConstProps</span><span class="p">,</span> <span class="n">projInit</span><span class="p">,</span> <span class="n">constInit</span><span class="p">,</span> <span class="n">projMatrix</span><span class="p">,</span>
                    <span class="n">constMatrix</span><span class="p">,</span> <span class="n">cellTypeMeans</span><span class="p">,</span> <span class="n">parentCellType</span><span class="p">,</span>
                    <span class="n">transcriptionFactors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add children to tree</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cellTypeTree : tree</span>
<span class="sd">        tree representation of the cell development</span>
<span class="sd">    cellTypeParents :</span>
<span class="sd">        the value at index `i` is the parent type of cell type `i`</span>
<span class="sd">    cellTypeMembers :</span>
<span class="sd">    cellTypeConstProps :</span>
<span class="sd">    projInit :</span>
<span class="sd">    constInit :</span>
<span class="sd">    projMatrix :</span>
<span class="sd">    constMatrix :</span>
<span class="sd">    cellTypeMeans :</span>
<span class="sd">    parentCellType :</span>
<span class="sd">    transcriptionFactors :</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">childCellTypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cellTypeParents</span><span class="p">)</span> <span class="o">==</span> <span class="n">parentCellType</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parentCellTypeMember</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">childCellTypes</span><span class="p">)):</span>
        <span class="n">childCellType</span> <span class="o">=</span> <span class="n">childCellTypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">constProp</span> <span class="o">=</span> <span class="n">cellTypeConstProps</span><span class="p">[</span><span class="n">childCellType</span><span class="p">]</span>
        <span class="n">proj</span><span class="p">,</span> <span class="n">const</span> <span class="o">=</span> <span class="n">getNextProjConst</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">projInit</span><span class="p">,</span> <span class="n">constInit</span><span class="p">,</span> <span class="n">constProp</span><span class="p">,</span>
                                       <span class="n">transcriptionFactors</span><span class="p">)</span>
        <span class="n">cellTypeMean</span> <span class="o">=</span> <span class="n">cellTypeMeans</span><span class="p">[</span><span class="n">childCellType</span><span class="p">]</span>
        <span class="n">cellTypeMember</span> <span class="o">=</span> <span class="n">cellTypeMembers</span><span class="p">[</span><span class="n">childCellType</span><span class="p">]</span>

        <span class="n">projMatrix</span><span class="p">[</span><span class="n">childCellType</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="n">constMatrix</span><span class="p">[</span><span class="n">childCellType</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">const</span>

        <span class="n">cellTypeNode</span> <span class="o">=</span> <span class="n">cellTypeTree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">childCellType</span><span class="p">,</span> <span class="n">cellTypeMember</span><span class="p">,</span>
                                             <span class="n">const</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">cellTypeMean</span><span class="p">,</span>
                                             <span class="n">parentCellType</span><span class="p">)</span>

        <span class="n">childCellTypeMember</span> <span class="o">=</span> <span class="n">addTreeChildren</span><span class="p">(</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">cellTypeTree</span><span class="p">,</span> <span class="n">cellTypeParents</span><span class="p">,</span> <span class="n">cellTypeMembers</span><span class="p">,</span>
            <span class="n">cellTypeConstProps</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">projMatrix</span><span class="p">,</span> <span class="n">constMatrix</span><span class="p">,</span>
            <span class="n">cellTypeMeans</span><span class="p">,</span> <span class="n">childCellType</span><span class="p">,</span> <span class="n">transcriptionFactors</span><span class="p">)</span>
        <span class="n">parentCellTypeMember</span> <span class="o">+=</span> <span class="n">childCellTypeMember</span>
    <span class="n">cellTypeTree</span><span class="p">[</span><span class="n">parentCellType</span><span class="p">]</span><span class="o">.</span><span class="n">setChildCellTypeMembers</span><span class="p">(</span><span class="n">parentCellTypeMember</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parentCellTypeMember</span> <span class="o">+</span> <span class="n">cellTypeMembers</span><span class="p">[</span><span class="n">parentCellType</span><span class="p">]</span></div>


<div class="viewcode-block" id="getNextProjConst"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.getNextProjConst">[docs]</a><span class="k">def</span> <span class="nf">getNextProjConst</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">projInit</span><span class="p">,</span> <span class="n">constInit</span><span class="p">,</span> <span class="n">constProp</span><span class="p">,</span> <span class="n">transcriptionFactors</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate new projection and constant vectors</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    projInit : ndarray(n)</span>
<span class="sd">        initial projection vector</span>
<span class="sd">    constInit : ndarray(n)</span>
<span class="sd">        initial constant vector</span>
<span class="sd">    constProp : float</span>
<span class="sd">        proportion of entries of constant vector to be changed</span>
<span class="sd">    transcriptionFactors : ndarray(*)</span>
<span class="sd">        list of genes with positive outdegree</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    proj : ndarray(n)</span>
<span class="sd">        new projection vector</span>
<span class="sd">    const : ndarray</span>
<span class="sd">        new const vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numZeros</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transcriptionFactors</span><span class="p">)</span> <span class="o">*</span>
                   <span class="n">constProp</span><span class="p">)</span>  <span class="c1">#np.random.binomial(n, constProp, 1)[0]</span>
    <span class="n">zeroGenes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span><span class="n">transcriptionFactors</span><span class="p">),</span> <span class="n">numZeros</span><span class="p">)</span>

    <span class="n">proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">projInit</span><span class="p">)</span>
    <span class="n">proj</span><span class="p">[</span><span class="n">zeroGenes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">constInit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">projInit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1">#Only if cell is zero in only new proj</span>
            <span class="n">const</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rangeTransformation</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span></div>


<div class="viewcode-block" id="generateInitialStates"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.generateInitialStates">[docs]</a><span class="k">def</span> <span class="nf">generateInitialStates</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">sameInitialCell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate initial gene expression state</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        number of cells</span>
<span class="sd">    sameInitialCell : logical</span>
<span class="sd">        if true, use same initial state for each cell, otherwise generate different initial state for each cell</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    initialStates : ndarray()</span>
<span class="sd">        initial states of cells expression levels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">initialStates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">))</span>
    <span class="n">baseInitialState</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">geneMeanLevels</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sameInitialCell</span><span class="p">:</span>
            <span class="n">initialStates</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseInitialState</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initialStates</span><span class="p">[:,</span>
                          <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">geneMeanLevels</span>
    <span class="k">return</span> <span class="n">initialStates</span></div>


<div class="viewcode-block" id="findOptimalAlpha"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.findOptimalAlpha">[docs]</a><span class="k">def</span> <span class="nf">findOptimalAlpha</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>
                     <span class="n">gc</span><span class="p">,</span>
                     <span class="n">cellTypeTree</span><span class="p">,</span>
                     <span class="n">currentStates</span><span class="p">,</span>
                     <span class="n">numToSample</span><span class="p">,</span>
                     <span class="n">timeStep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                     <span class="n">convergenceThreshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                     <span class="n">noiseDisp</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                     <span class="n">maxNumIterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                     <span class="n">convDistAvgNum</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">initialAlpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                     <span class="n">alphaStep</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                     <span class="n">showAlphaGeneMeans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">geneMeanLevels</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find smallest :math:`alpha` large enough to allow convergence</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of genes</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        Gene expression correlation matrix</span>
<span class="sd">    cellTypeTree : tree</span>
<span class="sd">        cell types represented as tree</span>
<span class="sd">    currentStates : ndarray()</span>
<span class="sd">        current states of cells&#39; expression levels</span>
<span class="sd">    numToSample : int</span>
<span class="sd">        number of cells to sample, must be less than or equal to number of cells</span>
<span class="sd">    timeStep : float</span>
<span class="sd">        time step for dynamics</span>
<span class="sd">    convergenceThreshold : float</span>
<span class="sd">        threshold for S convergence</span>
<span class="sd">    noiseDisp : float</span>
<span class="sd">        standard deviation of normal noise added to obtain new expression state</span>
<span class="sd">    maxNumIterations : int</span>
<span class="sd">        maximum numbe of iterations</span>
<span class="sd">    convDistAvgNum : int</span>
<span class="sd">        number of states to average over to determine convergence</span>
<span class="sd">    initialAlpha : float</span>
<span class="sd">        initial value of :math:`alpha`</span>
<span class="sd">    alphaStep : float</span>
<span class="sd">        step size for incrementing :math:`alpha`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alpha : float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Initialize variables (not to be changed)</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">currentStates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">successRateNeeded</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">numSuccessesNeeded</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numToSample</span> <span class="o">*</span> <span class="n">successRateNeeded</span><span class="p">)</span>
    <span class="n">successRate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initialAlpha</span> <span class="o">&gt;=</span> <span class="n">alphaStep</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">initialAlpha</span> <span class="o">-</span> <span class="n">alphaStep</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">avgIterations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">normDiffVals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">maxNumIterations</span>

    <span class="n">treeHead</span> <span class="o">=</span> <span class="n">cellTypeTree</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">treeHead</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1">#If only one cell lineage, use head</span>
        <span class="n">origCellType</span> <span class="o">=</span> <span class="n">cellTypeTree</span><span class="p">[(</span><span class="n">treeHead</span><span class="o">.</span><span class="n">children</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">origCellType</span><span class="o">.</span><span class="n">proj</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">origCellType</span><span class="o">.</span><span class="n">const</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1">#Multiple cell lineages</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#While proportion of cells that have converged is less than the required proportion</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">successRate</span> <span class="o">&lt;</span> <span class="n">successRateNeeded</span><span class="p">):</span>
        <span class="n">geneMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

        <span class="c1">#Sample cells and save them in a new array so they don&#39;t overwrite old values</span>
        <span class="n">cellsToSample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span> <span class="n">numToSample</span><span class="p">)</span>
        <span class="n">simulatedStates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">numToSample</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numToSample</span><span class="p">):</span>
            <span class="n">simulatedStates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">cellsToSample</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="c1">#Initialize these parameters at the start of every run of each alpha</span>
        <span class="n">numSuccesses</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">successRate</span> <span class="o">&gt;</span>
                <span class="mi">0</span><span class="p">):</span>  <span class="c1">#Slow down alphaStep once at least one cell converges</span>
            <span class="n">alphaStep</span> <span class="o">=</span> <span class="mf">0.01</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">alphaStep</span>
        <span class="n">avgIterations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#For each cell being sampled</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numToSample</span><span class="p">):</span>
            <span class="n">initialState</span> <span class="o">=</span> <span class="n">simulatedStates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">cellIteration</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">normDiffVals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">maxNumIterations</span>
            <span class="n">convDist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
            <span class="n">gc_alpha</span> <span class="o">=</span> <span class="n">gc</span> <span class="o">/</span> <span class="n">alpha</span>

            <span class="c1">#Develop each cell until the maximum number of iterations is reached or until it converges</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">cellIteration</span> <span class="o">&lt;</span> <span class="n">maxNumIterations</span>
                   <span class="ow">and</span> <span class="n">convDist</span> <span class="o">&gt;</span> <span class="n">convergenceThreshold</span><span class="p">):</span>
                <span class="n">currentState</span> <span class="o">=</span> <span class="n">developCell</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gc_alpha</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                                           <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span>
                                           <span class="n">geneMeanLevels</span><span class="p">)</span>
                <span class="n">normDiffVals</span><span class="p">[</span><span class="n">cellIteration</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">currentState</span> <span class="o">-</span> <span class="n">initialState</span><span class="p">)</span> <span class="o">/</span> <span class="n">timeStep</span>
                <span class="p">)</span>  <span class="c1">#np.linalg.norm((currentState - initialState)) / n #vector norm</span>

                <span class="c1">#Average average value of derivative over previous &quot;convDistAvgNum&quot; iterations</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cellIteration</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">convDistAvgNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="n">convDist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="n">normDiffVals</span><span class="p">[(</span><span class="n">cellIteration</span> <span class="o">-</span> <span class="n">convDistAvgNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):(</span>
                            <span class="n">cellIteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
                <span class="n">initialState</span> <span class="o">=</span> <span class="n">currentState</span>
                <span class="n">cellIteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cellIteration</span> <span class="o">!=</span> <span class="n">maxNumIterations</span><span class="p">):</span>  <span class="c1">#If the cell has converged</span>
                <span class="n">numSuccesses</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">avgIterations</span> <span class="o">+=</span> <span class="n">cellIteration</span>
            <span class="n">geneMeans</span> <span class="o">+=</span> <span class="n">currentState</span>
        <span class="n">geneMeans</span> <span class="o">/=</span> <span class="n">numToSample</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">showAlphaGeneMeans</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">geneMeans</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gene Means for alpha: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">successRate</span> <span class="o">=</span> <span class="n">numSuccesses</span> <span class="o">/</span> <span class="n">numToSample</span>
        <span class="n">avgIterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">avgIterations</span> <span class="o">/</span> <span class="n">numToSample</span><span class="p">)</span>
        <span class="n">avgIterations</span> <span class="o">=</span> <span class="n">avgIterations</span> <span class="o">-</span> <span class="n">convDistAvgNum</span>  <span class="c1">#Subtract iterations where it is below convergence distance</span>
        <span class="k">if</span> <span class="n">__verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alpha: &quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Success Rate: &quot;</span><span class="p">,</span> <span class="n">successRate</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average Iterations: &quot;</span><span class="p">,</span> <span class="n">avgIterations</span><span class="p">)</span>
    <span class="c1">#xVals = [x for x in range(0, cellIteration)]</span>
    <span class="c1">#plt.scatter(xVals, normDiffVals[0:cellIteration])</span>
    <span class="c1">#plt.plot(xVals, normDiffVals[0:cellIteration])</span>
    <span class="c1">#plt.show()</span>
    <span class="k">return</span> <span class="n">alpha</span></div>


<div class="viewcode-block" id="developCell"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.developCell">[docs]</a><span class="k">def</span> <span class="nf">developCell</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span>
                <span class="n">geneMeanLevels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Equation to develop each cell for a time step</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        gene correlation matrix</span>
<span class="sd">    timeStep : float</span>
<span class="sd">        change in time for consecutive iterations</span>
<span class="sd">    initialState : ndarray()</span>
<span class="sd">        initial expression levels of the cells</span>
<span class="sd">    proj : ndarray(n)</span>
<span class="sd">        projection vector</span>
<span class="sd">    const : ndarray(n)</span>
<span class="sd">        constant vector</span>
<span class="sd">    noiseDisp : float</span>
<span class="sd">        standard deviation of normal noise added to next state</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    currentState : ndarray(n)</span>
<span class="sd">        expression levels of genes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">nextState</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">initialState</span> <span class="o">-</span> <span class="n">geneMeanLevels</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">noiseDisp</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
    <span class="n">derivative</span> <span class="o">=</span> <span class="p">(</span><span class="n">nextState</span> <span class="o">-</span> <span class="n">initialState</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">initialState</span> <span class="o">+</span> <span class="n">timeStep</span> <span class="o">*</span> <span class="n">derivative</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">currentState</span><span class="p">)</span> <span class="o">+</span> <span class="n">const</span> <span class="o">+</span> <span class="n">geneMeanLevels</span>

    <span class="k">return</span> <span class="n">currentState</span></div>


<div class="viewcode-block" id="findAllNextStates"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.findAllNextStates">[docs]</a><span class="k">def</span> <span class="nf">findAllNextStates</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span>
                      <span class="n">cellTypeNode</span><span class="p">,</span>
                      <span class="n">cellTypeTree</span><span class="p">,</span>
                      <span class="n">currentStates</span><span class="p">,</span>
                      <span class="n">cellTypesRecord</span><span class="p">,</span>
                      <span class="n">totalCellIterations</span><span class="p">,</span>
                      <span class="n">timeStep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                      <span class="n">noiseDisp</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                      <span class="n">convergenceThreshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">maxNumIterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                      <span class="n">convDistAvgNum</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                      <span class="n">cellsToSample</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                      <span class="n">showPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">cellDevelopmentMode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">geneMeanLevels</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find all next states</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        gene correlation matrix</span>
<span class="sd">    cellTypeNode :</span>
<span class="sd">    cellTypeTree :</span>
<span class="sd">    currentStates :</span>
<span class="sd">    cellTypesRecord :</span>
<span class="sd">    totalCellIterations :</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">currentCellType</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">identifier</span>
    <span class="n">cellTypeMembers</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">cellTypeMembers</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">proj</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">const</span>
    <span class="n">childCellTypeMembers</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">childCellTypeMembers</span>

    <span class="n">cellTypesRecord</span><span class="p">[</span><span class="n">cellTypeMembers</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">currentCellType</span><span class="p">)</span>
    <span class="c1"># print(&quot;Current Cell Type: &quot;, currentCellType)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellTypeMembers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cellTypeIterations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#print(&quot;Constant Gene Proportion: &quot;, 1 - float(np.count_nonzero(proj))/np.size(proj))</span>
        <span class="n">cellTypeIterations</span> <span class="o">=</span> <span class="n">findOptimalIterations</span><span class="p">(</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">cellTypeMembers</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">,</span>
            <span class="n">convergenceThreshold</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">currentStates</span><span class="p">,</span> <span class="n">maxNumIterations</span><span class="p">,</span>
            <span class="n">convDistAvgNum</span><span class="p">,</span> <span class="n">cellsToSample</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cellTypeMembers</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cellDevelopmentMode</span><span class="p">:</span>
                <span class="n">cellIterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cellTypeIterations</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cellIterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">cellTypeIterations</span><span class="p">)</span>
            <span class="n">cellTypeMember</span> <span class="o">=</span> <span class="n">cellTypeMembers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">initialState</span> <span class="o">=</span> <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">cellTypeMember</span><span class="p">]</span>
            <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">cellTypeMember</span><span class="p">]</span> <span class="o">=</span> <span class="n">findCellNextState</span><span class="p">(</span>
                <span class="n">gc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">cellIterations</span><span class="p">,</span>
                <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">,</span> <span class="n">showPlots</span><span class="p">)</span>
            <span class="n">totalCellIterations</span><span class="p">[</span><span class="n">cellTypeMember</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cellIterations</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">childCellTypeMembers</span><span class="p">)):</span>
            <span class="n">cellIterations</span> <span class="o">=</span> <span class="n">cellTypeIterations</span>
            <span class="n">childCellTypeMember</span> <span class="o">=</span> <span class="n">childCellTypeMembers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">initialState</span> <span class="o">=</span> <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">childCellTypeMember</span><span class="p">]</span>
            <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">childCellTypeMember</span><span class="p">]</span> <span class="o">=</span> <span class="n">findCellNextState</span><span class="p">(</span>
                <span class="n">gc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">cellIterations</span><span class="p">,</span>
                <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">,</span> <span class="n">showPlots</span><span class="p">)</span>
            <span class="n">totalCellIterations</span><span class="p">[</span><span class="n">childCellTypeMember</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cellIterations</span>

    <span class="n">cellTypeNodeChildrenIDs</span> <span class="o">=</span> <span class="n">cellTypeNode</span><span class="o">.</span><span class="n">children</span>
    <span class="k">for</span> <span class="n">cellTypeNodeChildID</span> <span class="ow">in</span> <span class="n">cellTypeNodeChildrenIDs</span><span class="p">:</span>
        <span class="n">cellTypeNodeChild</span> <span class="o">=</span> <span class="n">cellTypeTree</span><span class="p">[</span><span class="n">cellTypeNodeChildID</span><span class="p">]</span>

        <span class="n">findAllNextStates</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">cellTypeNodeChild</span><span class="p">,</span> <span class="n">cellTypeTree</span><span class="p">,</span> <span class="n">currentStates</span><span class="p">,</span>
                          <span class="n">cellTypesRecord</span><span class="p">,</span> <span class="n">totalCellIterations</span><span class="p">)</span></div>


<span class="c1">#Given a W matrix and the projection/constant vectors, find the minimum number of iterations until convergence</span>
<div class="viewcode-block" id="findOptimalIterations"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.findOptimalIterations">[docs]</a><span class="k">def</span> <span class="nf">findOptimalIterations</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">cellTypeMembers</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span>
                          <span class="n">geneMeanLevels</span><span class="p">,</span> <span class="n">convergenceThreshold</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span>
                          <span class="n">currentStates</span><span class="p">,</span> <span class="n">maxNumIterations</span><span class="p">,</span> <span class="n">convDistAvgNum</span><span class="p">,</span>
                          <span class="n">numToSample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find optimal iterations</span>

<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        gene correlation matrix</span>
<span class="sd">    timeStep : float</span>
<span class="sd">        dynamics time step</span>
<span class="sd">    cellTypeMembers :</span>
<span class="sd">    proj :</span>
<span class="sd">    const :</span>
<span class="sd">    geneMeanLevels :</span>
<span class="sd">    convergenceThreshold :</span>
<span class="sd">    noiseDisp :</span>
<span class="sd">    currentStates :</span>
<span class="sd">    maxNumIterations :</span>
<span class="sd">    convDistAvgNum :</span>
<span class="sd">    numToSample :</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Initialize variables (not to be changed)</span>
    <span class="n">avgIterations</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">normDiffVals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">maxNumIterations</span>

    <span class="c1">#Sample cells and save them in a new array so they don&#39;t overwrite old values</span>
    <span class="n">colsToSample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">cellTypeMembers</span><span class="p">,</span> <span class="n">numToSample</span><span class="p">)</span>
    <span class="n">simulatedStates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">numToSample</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numToSample</span><span class="p">):</span>
        <span class="n">simulatedStates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentStates</span><span class="p">[:,</span> <span class="n">colsToSample</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="c1">#For each cell being sampled</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numToSample</span><span class="p">):</span>
        <span class="n">initialState</span> <span class="o">=</span> <span class="n">simulatedStates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">cellIteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">normDiffVals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">maxNumIterations</span>
        <span class="n">convDist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>

        <span class="c1">#Develop each cell until the maximum number of iterations is reached or until it converges</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">cellIteration</span> <span class="o">&lt;</span> <span class="n">maxNumIterations</span>
               <span class="ow">and</span> <span class="n">convDist</span> <span class="o">&gt;</span> <span class="n">convergenceThreshold</span><span class="p">):</span>
            <span class="n">currentState</span> <span class="o">=</span> <span class="n">developCell</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span>
                                       <span class="n">const</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">)</span>
            <span class="n">normDiffVals</span><span class="p">[</span><span class="n">cellIteration</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">currentState</span> <span class="o">-</span> <span class="n">initialState</span><span class="p">)</span> <span class="o">/</span> <span class="n">timeStep</span>
            <span class="p">)</span>  <span class="c1">#np.linalg.norm((currentState - initialState)) / n #vector norm</span>

            <span class="c1">#Average average value of derivative over previous &quot;convDistAvgNum&quot; iterations</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cellIteration</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">convDistAvgNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">convDist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">normDiffVals</span><span class="p">[(</span>
                    <span class="n">cellIteration</span> <span class="o">-</span> <span class="n">convDistAvgNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):(</span><span class="n">cellIteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="n">initialState</span> <span class="o">=</span> <span class="n">currentState</span>
            <span class="n">cellIteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">avgIterations</span> <span class="o">+=</span> <span class="n">cellIteration</span>
    <span class="n">avgIterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">avgIterations</span> <span class="o">/</span> <span class="n">numToSample</span><span class="p">)</span>
    <span class="n">avgIterations</span> <span class="o">=</span> <span class="n">avgIterations</span> <span class="o">-</span> <span class="n">convDistAvgNum</span>  <span class="c1">#Subtract iterations where it is below convergence distance</span>
    <span class="k">if</span> <span class="n">__verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Average Iterations: &quot;</span><span class="p">,</span> <span class="n">avgIterations</span><span class="p">)</span>
    <span class="c1">#xVals = [x for x in range(0, cellIteration)]</span>
    <span class="c1">#plt.scatter(xVals, normDiffVals[0:cellIteration])</span>
    <span class="c1">#plt.plot(xVals, normDiffVals[0:cellIteration])</span>
    <span class="c1">#plt.show()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">avgIterations</span><span class="p">)</span></div>


<div class="viewcode-block" id="findCellNextState"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.findCellNextState">[docs]</a><span class="k">def</span> <span class="nf">findCellNextState</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span>
                      <span class="n">cellIterations</span><span class="p">,</span> <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">,</span> <span class="n">showPlots</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find cell&#39;s next state</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gc : ndarray(n,n)</span>
<span class="sd">        gene correlation matrix</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    timeStep : float</span>
<span class="sd">        dynamics time step</span>
<span class="sd">    i :</span>
<span class="sd">    proj :</span>
<span class="sd">    const :</span>
<span class="sd">    initialState :</span>
<span class="sd">    cellIterations :</span>
<span class="sd">    noiseDisp :</span>
<span class="sd">    geneMeanLevels :</span>
<span class="sd">    showPlots :</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normDiffVals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cellIterations</span>
    <span class="n">currentState</span> <span class="o">=</span> <span class="n">initialState</span>

    <span class="n">gene</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">geneExpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cellIterations</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cellIterations</span><span class="p">):</span>
        <span class="n">yVals</span> <span class="o">=</span> <span class="n">initialState</span>
        <span class="n">geneExpr</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialState</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span>
        <span class="n">currentState</span> <span class="o">=</span> <span class="n">developCell</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">timeStep</span><span class="p">,</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">const</span><span class="p">,</span>
                                   <span class="n">noiseDisp</span><span class="p">,</span> <span class="n">geneMeanLevels</span><span class="p">)</span>
        <span class="n">normDiffVals</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">currentState</span> <span class="o">-</span> <span class="n">initialState</span>
                        <span class="p">))</span>  <span class="c1">#np.linalg.norm((currentState - initialState))</span>
        <span class="n">initialState</span> <span class="o">=</span> <span class="n">currentState</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">showPlots</span><span class="p">):</span>
        <span class="n">xVals</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cellIterations</span><span class="p">)]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Convergence Graph&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xVals</span><span class="p">,</span> <span class="n">normDiffVals</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Gene &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Over Time&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xVals</span><span class="p">,</span> <span class="n">geneExpr</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xVals</span><span class="p">,</span> <span class="n">geneExpr</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Current Distribution of Gene Expression&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">yVals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">25</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">currentState</span><span class="p">)</span></div>


<div class="viewcode-block" id="analyzeDataBeforeTransformation"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.analyzeDataBeforeTransformation">[docs]</a><span class="k">def</span> <span class="nf">analyzeDataBeforeTransformation</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">finalCellStates</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span>
                                    <span class="n">pseudotimes</span><span class="p">,</span> <span class="n">networkStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze data before transformation</span>

<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        number of cells</span>
<span class="sd">    finalCellStates :</span>
<span class="sd">    alpha :</span>
<span class="sd">    pseudotimes :</span>
<span class="sd">    networkStructure :</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">randomGenes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1">#What do you want to name the graphs?</span>
    <span class="n">testingAlpha</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">testingNetworkStructure</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">testingAlpha</span><span class="p">):</span>
        <span class="n">testingString</span> <span class="o">=</span> <span class="s2">&quot;_Alpha_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>  <span class="c1">#What is being tested</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">testingNetworkStructure</span><span class="p">):</span>
        <span class="n">testingString</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">networkStructure</span> <span class="o">+</span> <span class="s2">&quot;_Network&quot;</span>  <span class="c1">#What is being tested</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testingString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">__outputDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">SGeneMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">finalCellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">geneMeansString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;S_Gene_Means&quot;</span> <span class="o">+</span> <span class="n">testingString</span> <span class="o">+</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">SGeneMeans</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;S Gene Means&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">geneMeansString</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">SGeneVars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">finalCellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">geneVarsString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span>
                                      <span class="s2">&quot;S_Gene_Vars&quot;</span> <span class="o">+</span> <span class="n">testingString</span> <span class="o">+</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">SGeneVars</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;S Gene Variances&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">geneVarsString</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">SCellMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">finalCellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cellMeansString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;S_Cell_Means&quot;</span> <span class="o">+</span> <span class="n">testingString</span> <span class="o">+</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">SCellMeans</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cells</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;S Cell Means&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">cellMeansString</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">__verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Random Genes Being Graphed: &quot;</span><span class="p">,</span> <span class="n">randomGenes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">randomGene</span> <span class="ow">in</span> <span class="n">randomGenes</span><span class="p">:</span>
            <span class="n">geneExpr</span> <span class="o">=</span> <span class="n">finalCellStates</span><span class="p">[</span><span class="n">randomGene</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">genePseudotimeString</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Gene_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">randomGene</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_Pseudotime&quot;</span> <span class="o">+</span>
                <span class="n">testingString</span> <span class="o">+</span> <span class="s2">&quot;.tiff&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pseudotimes</span><span class="p">,</span> <span class="n">geneExpr</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pseudotime&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;S Gene Expression&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">genePseudotimeString</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="transformData"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.transformData">[docs]</a><span class="k">def</span> <span class="nf">transformData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>
                  <span class="n">cells</span><span class="p">,</span>
                  <span class="n">finalCellStates</span><span class="p">,</span>
                  <span class="n">dropoutProportion</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">cellRadiusDisp</span><span class="o">=</span><span class="mf">0.14</span><span class="p">,</span>
                  <span class="n">geneScale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">expScale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">expLambda</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">shape</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
                  <span class="n">rate</span><span class="o">=</span><span class="mf">0.19</span><span class="p">,</span>
                  <span class="n">gammaDistMean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        number of cells</span>
<span class="sd">    finalCellStates :</span>
<span class="sd">    dropoutProportion :</span>
<span class="sd">    cellRadiusDisp :</span>
<span class="sd">    geneScale :</span>
<span class="sd">    expScale :</span>
<span class="sd">    expLambda :</span>
<span class="sd">    shape :</span>
<span class="sd">    rate :</span>
<span class="sd">    gammaDistMean :</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    finalCellStates :</span>
<span class="sd">    cellSizeFactors :</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">originalGeneMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">finalCellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">geneMeanRankings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">originalGeneMeans</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">gammaDistMean</span><span class="p">):</span>
        <span class="n">newGeneMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">))</span> <span class="o">/</span> <span class="n">expScale</span>
        <span class="n">newGeneMeansSorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">newGeneMeans</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geneMeanRankings</span><span class="p">)):</span>
            <span class="n">geneIndex</span> <span class="o">=</span> <span class="n">geneMeanRankings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">finalCellStates</span><span class="p">[</span><span class="n">geneIndex</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">newGeneMeansSorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">finalCellStates</span><span class="p">[</span><span class="n">geneIndex</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">newGeneMeanOffsets</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">geneScale</span> <span class="o">+</span> <span class="n">expLambda</span><span class="p">)</span> <span class="o">/</span> <span class="n">expScale</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span>
                <span class="n">expLambda</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">newGeneMeansSorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">newGeneMeanOffsets</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">geneMeanRankings</span><span class="p">)):</span>
            <span class="n">geneIndex</span> <span class="o">=</span> <span class="n">geneMeanRankings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">finalCellStates</span><span class="p">[</span><span class="n">geneIndex</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">newGeneMeansSorted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">finalCellStates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">expScale</span> <span class="o">*</span> <span class="n">finalCellStates</span><span class="p">)</span>

    <span class="n">cellSizeFactors</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
        <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">cellRadiusDisp</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="n">finalCellStates</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">cellSizeFactors</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">finalCellStates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">finalCellStates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">finalCellStates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span>
                <span class="n">lam</span><span class="o">=</span><span class="n">finalCellStates</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>

        <span class="c1">#numCellKeep = numCellsKeep[i]</span>
        <span class="c1">#zeroCells = random.sample(range(cells), cells - numCellKeep)</span>
        <span class="c1">#finalCellStates[i, zeroCells] = 0</span>

    <span class="k">return</span> <span class="n">finalCellStates</span><span class="p">,</span> <span class="n">cellSizeFactors</span></div>


<div class="viewcode-block" id="analyzeSCRNAseqData"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.analyzeSCRNAseqData">[docs]</a><span class="k">def</span> <span class="nf">analyzeSCRNAseqData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">cells</span><span class="p">,</span>
                        <span class="n">cellTypesRecord</span><span class="p">,</span>
                        <span class="n">finalCellStates</span><span class="p">,</span>
                        <span class="n">perplexityParam</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Analyze scRNA-seq data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        number of cells</span>
<span class="sd">    cellTypesRecord : ndarray</span>
<span class="sd">        record of cell types</span>
<span class="sd">    finalCellStates : ndarray</span>
<span class="sd">    perplexityParam : int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cellTypeString</span> <span class="o">=</span> <span class="s2">&quot;All&quot;</span>
    <span class="k">if</span> <span class="n">__outputDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotSCRNAseqData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">finalCellStates</span><span class="p">,</span> <span class="n">cellTypeString</span><span class="p">)</span>

    <span class="n">cellTypesSet</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cellTypesRecord</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">cellTypeNum</span> <span class="ow">in</span> <span class="n">cellTypesSet</span><span class="p">:</span>
        <span class="n">cellTypeString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellTypeNum</span><span class="p">)</span>
        <span class="n">cellTypeIndices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="k">if</span> <span class="n">cellTypesRecord</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cellTypeNum</span>
        <span class="p">]</span>
        <span class="n">finalCellStatesOfType</span> <span class="o">=</span> <span class="n">finalCellStates</span><span class="p">[:,</span> <span class="n">cellTypeIndices</span><span class="p">]</span>
        <span class="n">plotSCRNAseqData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span>
                         <span class="nb">len</span><span class="p">(</span><span class="n">cellTypeIndices</span><span class="p">),</span> <span class="n">finalCellStatesOfType</span><span class="p">,</span>
                         <span class="n">cellTypeString</span><span class="p">)</span>

    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">pcaFit</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">finalCellStates</span><span class="p">)</span>
    <span class="n">pcaResult</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span>
    <span class="k">if</span> <span class="n">__verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PCA Explained Var: &quot;</span><span class="p">,</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">__outputDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Variance_Explained&quot;</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">))</span>
    <span class="n">xVals</span> <span class="o">=</span> <span class="n">pcaResult</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">yVals</span> <span class="o">=</span> <span class="n">pcaResult</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">__outputDir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xVals</span><span class="p">,</span> <span class="n">yVals</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1"># model = TSNE(n_components=2, perplexity=perplexityParam)</span>
    <span class="c1"># np.set_printoptions(suppress=True)</span>
    <span class="c1"># tsneResult = model.fit_transform(np.transpose(finalCellStates)) #Transpose because cells are data we are clustering</span>

    <span class="c1"># palette = np.array(sns.color_palette(&quot;hls&quot;, max(cellTypesRecord)+1))</span>

    <span class="c1"># # We create a scatter plot.</span>
    <span class="c1"># f = plt.figure(figsize=(8, 8))</span>
    <span class="c1"># ax = plt.subplot(aspect=&#39;equal&#39;)</span>

    <span class="c1"># colorHandles = []</span>
    <span class="c1"># for cellTypeNum in cellTypesSet:</span>
    <span class="c1"># 	colorHandles.append(mpatches.Patch(color=palette[cellTypeNum], label=cellTypeNum))</span>

    <span class="c1"># plt.legend(handles=colorHandles, borderaxespad=0)</span>

    <span class="c1"># sc = ax.scatter(tsneResult[:,0], tsneResult[:,1], lw=0, s=40, c=palette[cellTypesRecord.astype(np.int)])</span>
    <span class="c1"># ax.axis(&#39;off&#39;)</span>
    <span class="c1"># ax.axis(&#39;tight&#39;)</span>
    <span class="c1"># #plt.show()</span>
    <span class="c1"># plt.savefig(&quot;t-SNE&quot;)</span>


<div class="viewcode-block" id="plotSCRNAseqData"><a class="viewcode-back" href="../../docs/source/RNAscrutiny.html#RNAscrutiny.RNAscrutiny.plotSCRNAseqData">[docs]</a><span class="k">def</span> <span class="nf">plotSCRNAseqData</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">cellStates</span><span class="p">,</span> <span class="n">cellTypeString</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot scRNA-seq data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of genes</span>
<span class="sd">    cells : int</span>
<span class="sd">        Number of cells</span>
<span class="sd">    cellStates : ndarray</span>
<span class="sd">    cellTypeString :</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numBinsScalar</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Cell_Type_&quot;</span> <span class="o">+</span> <span class="n">cellTypeString</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">geneExpr</span> <span class="o">=</span> <span class="n">cellStates</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span> <span class="p">:]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">geneExpr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cells</span> <span class="o">/</span> <span class="n">numBinsScalar</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Expression of Random Gene&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Expression_Of_Gene&quot;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">cellExpr</span> <span class="o">=</span> <span class="n">cellStates</span><span class="p">[:,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span> <span class="o">*</span> <span class="n">cells</span><span class="p">)]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cellExpr</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">numBinsScalar</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Expression of Random Cell&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Expression_Of_Cell&quot;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">geneMeansString</span> <span class="o">=</span> <span class="s2">&quot;Gene_Means_&quot;</span> <span class="o">+</span> <span class="s2">&quot;Cell_Type_&quot;</span> <span class="o">+</span> <span class="n">cellTypeString</span>
    <span class="n">librarySizesString</span> <span class="o">=</span> <span class="s2">&quot;Library_Sizes_&quot;</span> <span class="o">+</span> <span class="s2">&quot;Cell_Type_&quot;</span> <span class="o">+</span> <span class="n">cellTypeString</span>
    <span class="n">numExpressedGenesString</span> <span class="o">=</span> <span class="s2">&quot;Num_Expressed_Genes_&quot;</span> <span class="o">+</span> <span class="s2">&quot;Cell_Type_&quot;</span> <span class="o">+</span> <span class="n">cellTypeString</span>
    <span class="n">geneMeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">geneMeans</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">numBinsScalar</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gene Means&quot;</span><span class="p">)</span>  <span class="c1">#Change back to Log[10]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="n">geneMeansString</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">librarySizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cellStates</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">librarySizes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">numBinsScalar</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="s2">&quot;Library Sizes&quot;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="n">librarySizesString</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">numExpressedGenes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">cellNum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span>
        <span class="n">numExpressedGenes</span><span class="p">[</span><span class="n">cellNum</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cellStates</span><span class="p">[:,</span> <span class="n">cellNum</span><span class="p">])</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">numExpressedGenes</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">numBinsScalar</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Num Expressed Genes&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__outputDir</span><span class="p">,</span> <span class="n">numExpressedGenesString</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2017, Steffen K Cornwell, Joseph P McKenna, Vipul Periwal.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.5.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>